public String prWellsXchangeLog(Connection pCon, String pQueueRefNo) {
    this.logger.logInfo("Inside WellsXchangeProcedure.prWellsXchangeLog()..");

    // Initialize instance variables
    pStatus = -1;
    pRespStatus = null;
    pErrCode = null;
    pErrDesc = null;
    pIsTrusted = null;
    lExchRate = null;

    // Log initial state
    this.logger.logInfo("Inside WellsXchangeProcedure.prWellsXchangeLog() checkpoint 1");
    this.logger.logInfo("Creating connection in procedure now...");
    this.logger.logInfo(pQueueRefNo);

    // GBFALM-4528 starts
    String lBranchCode = null;
    String lDealSource = null;

    try {
        // Step 1: Load Data
        String lWxcLogRes = gJdbcObj.loadWXData(pCon, pQueueRefNo);
        this.logger.logInfo("Check point 2");
        this.logger.logInfo(lWxcLogRes);

        // Step 2: Parse Response
        String[] lWxcLog = lWxcLogRes.split("~");
        this.logger.logInfo("prWellsXchangeLog()..checkpoint 2");

        // Handle empty response
        if (lWxcLog.length == 0) {
            handleEmptyResponse(pCon);
            return buildReturnString(); // Early return for failure case
        }

        // Step 3: Process Valid Response
        processValidResponse(pCon, lWxcLog);

        // Step 4: Set Final Status if not already set
        if (pStatus == -1) {
            pStatus = 0;
        }
        if (pRespStatus == null) {
            pRespStatus = "WXC PASS";
        }

        // Step 5: GBFALM-4528 Logic
        lBranchCode = lWxcLog[25];
        lDealSource = lWxcLog[29];
        if (!fnIsTrustedSource(pCon, lBranchCode, lDealSource)) {
            this.logger.logInfo("Non-trusted deal source");
            pIsTrusted = "N";
        }
        if (pIsTrusted == null) {
            pIsTrusted = "N";
        }

        // Step 6: Update Log
        gJdbcObj.updateWXLog(pCon, pRespStatus, pIsTrusted, pQueueRefNo);

    } catch (Exception e) {
        // Handle any unexpected exception
        handleUnexpectedException(e, pCon);
        return null; // Return null on critical failure
    }

    // Step 7: Final Logging and Return
    this.logger.logInfo("Leaving prWellsXchangeLog()..");
    lExchRate = lWxcLog[24]; // Assuming lWxcLog is still accessible from the successful path

    return buildReturnString();
}

// --- HELPER METHODS ---

/**
 * Handles the case where the loaded log response is empty.
 */
private void handleEmptyResponse(Connection pCon) {
    this.logger.logInfo("prWellsXchangeLog()..checkpoint 3");
    pStatus = 1;
    pRespStatus = "WXC FAIL";
    if (!fnGetErtbMsgs(pCon, "WXCH-RSP-17")) {
        this.logger.logInfo("Failed in fetching error message");
    } else {
        pErrCode = "WXCH-RSP-17";
        pErrDesc += " Failed in fetching WXC response log";
    }
}

/**
 * Processes a non-empty log response array.
 */
private void processValidResponse(Connection pCon, String[] lWxcLog) {
    this.logger.logInfo("prWellsXchangeLog()..checkpoint 4");
    try {
        // Extract error code and status from the log
        extractErrorCodeAndStatus(lWxcLog);

        // Fetch error message based on the extracted code
        fetchErrorMessage(pCon);

        // Determine if there's an error or invalid status
        boolean hasErrorCode = lWxcLogErrCode != null && !"0".equals(lWxcLogErrCode) &&
                !"6470".equals(lWxcLogErrCode) && !"3870".equals(lWxcLogErrCode);
        boolean hasInvalidStatus = "Expired".equals(lWxcLogStatus) || "Canceled".equals(lWxcLogStatus);

        if (hasErrorCode || hasInvalidStatus) {
            this.logger.logInfo("WellsXchange response is empty");
            pStatus = 1;
            pRespStatus = "WXC FAIL";
            return; // Exit early if we have a known failure condition
        }

        // Perform payment validations
        if (!fnProcessPmt(pCon, pQueueRefNo, lWxcLog)) {
            this.logger.logInfo("Failed in login fnProcessPmt");
            pStatus = 1;
            pRespStatus = "WXC FAIL";
            if (!fnGetErtbMsgs(pCon, "WXCH-RSP-17")) {
                this.logger.logInfo("Failed in fetching error message");
            } else {
                pErrCode = "WXCH-RSP-17";
                pErrDesc += " Failed in performing WXC validations";
            }
        }

    } catch (Exception e) {
        // If processing fails, mark as general failure
        pStatus = 1;
        pRespStatus = "WXC FAIL";
        if (!fnGetErtbMsgs(pCon, "WXCH-RSP-17")) {
            this.logger.logInfo("Failed in fetching error message");
        } else {
            pErrCode = "WXCH-RSP-17";
            pErrDesc += " Failed in processing WXC data";
        }
    }
}

/**
 * Extracts the error code and status from the log array.
 */
private void extractErrorCodeAndStatus(String[] lWxcLog) {
    this.logger.logInfo("prWellsXchangeLog()..checkpoint 5");
    lWxcLogErrCode = lWxcLog[14];
    lWxcLogStatus = lWxcLog[13];

    if (lWxcLogErrCode == null) {
        pErrCode = null;
    } else {
        if (lWxcLogErrCode.charAt(0) == '-') {
            pErrCode = "WXC" + lWxcLogErrCode;
        } else {
            pErrCode = "WXC-" + lWxcLogErrCode;
        }
        this.logger.logInfo("pErrCode" + pErrCode);
    }
}

/**
 * Fetches the error message for the current pErrCode.
 */
private void fetchErrorMessage(Connection pCon) {
    if (!fnGetErtbMsgs(pCon, pErrCode)) {
        this.logger.logInfo("Failed in fetching error message");
    } else {
        this.logger.logInfo("Successfully fetched error message:" + pErrDesc);
    }
}

/**
 * Handles any unexpected exception that occurs during execution.
 */
private void handleUnexpectedException(Exception e, Connection pCon) {
    e.printStackTrace();
    pStatus = 1;
    pRespStatus = "WXC FAIL";
    if (!fnGetErtbMsgs(pCon, "WXCH-RSP-17")) {
        this.logger.logInfo("Failed in fetching error message");
    } else {
        pErrCode = "WXCH-RSP-17";
    }
    gJdbcObj.updateWXLog(pCon, pRespStatus, pIsTrusted, pQueueRefNo);
}

/**
 * Builds the final return string from the current state of instance variables.
 * @return The formatted result string.
 */
private String buildReturnString() {
    return pErrCode + "~" + pErrDesc + "~" + pStatus + "~" + lExchRate;
}
